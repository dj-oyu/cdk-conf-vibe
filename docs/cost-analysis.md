# コスト分析と変動要因

このドキュメントは、本プロジェクトで採用するサーバーレスアーキテクチャ（API Gateway + Lambda + DynamoDB）の運用コストを分析し、コストが変動しうるシナリオをまとめたものです。

---

## コスト分析の概要

結論として、このアーキテクチャは**非常にコスト効率が高い**です。`spec.md`に記載されている月額$5-7程度の試算は、通常の利用状況においては妥当な範囲です。しかし、コストは静的なものではなく、ユーザーの利用状況によって大きく変動する可能性があります。

以下に、コストを左右する主要な要因と、それに応じたシナリオを分析します。

---

## 主要なコストドライバーと変動シナリオ

コストは主に以下の4つの要素によって駆動されます。

1.  **同時接続ユーザー数とセッション時間**
2.  **ユーザーのアクティビティ（ルームへの参加・退出頻度）**
3.  **データ転送量（フロントエンドの静的コンテンツ）**
4.  **（最重要）TURNサーバーの利用**

---

### シナリオ1: 通常利用（`spec.md`の想定通り）

- **状況:** 少数のユーザーがルームに参加し、比較的長い時間（例: 30分〜1時間）コラボレーションを行う。
- **コストの内訳:**
    - **API Gateway:** `接続時間` に応じて課金されます。ユーザーが接続している時間が長いほど、このコストは増加します。
    - **Lambda:** ルームへの参加・退出といったシグナリングメッセージを処理するために、`呼び出し回数`に応じて課金されます。セッション中は呼び出しが発生しないため、コストは限定的です。
    - **DynamoDB:** 接続IDやルーム情報を保存・削除するために、`書き込み/読み込み回数`に応じて課金されます。これもセッション中は発生しません。
- **分析:** このシナリオでは、コストの大部分をAPI Gatewayの接続料金が占めますが、全体としては非常に安価に収まります。`spec.md`の試算は、このシナリオを想定したものと考えられます。

---

### シナリオ2: 高いユーザー離脱率（"Churn"）

- **状況:** 多くのユーザーが、ひっきりなしにルームへ参加し、すぐに退出するような使い方を繰り返す。（例: サービスを試しに来たユーザーが多い、イベントで短時間だけ利用される、など）
- **コストの内訳:**
    - **Lambda & DynamoDB:** ユーザーが参加/退出するたびにLambdaが起動し、DynamoDBへの書き込み/削除が発生します。この`呼び出し回数`と`書き込み回数`が急増し、これらのコストが無視できなくなります。
    - **API Gateway:** 個々のセッションが短いため、`接続時間`による課金は逆に低く抑えられる可能性があります。
- **分析:** このシナリオでは、LambdaとDynamoDBのコストが想定を上回る可能性があります。ただし、それでも全体的なコストが急激に跳ね上がる可能性は低いです。

---

### シナリオ3: フロントエンドの人気化

- **状況:** アプリケーション自体が非常に人気になり、多くのユーザーがアクセスするが、必ずしもコラボレーション機能を使うわけではない。
- **コストの内訳:**
    - **CloudFront & S3:** Reactアプリのダウンロード（静的コンテンツの配信）が増加し、`データ転送量`に応じた課金が増加します。
- **分析:** これはバックエンドのシグナリングコストとは直接関係ありませんが、プロジェクト全体の運用コストとしては考慮すべき点です。

---

### シナリオ4: TURNサーバーの常時利用

これは**最もコストインパクトの大きいシナリオ**です。

- **状況:** 多くのユーザーが、UDP通信をブロックする企業内ネットワークや厳しいファイアウォールの内側からアクセスし、P2P接続に失敗する。その結果、フォールバックとしてTURNサーバーが利用される。
- **コストの内訳:**
    - **EC2インスタンス:** `t4g.micro`インスタンスの`固定時間料金`がまず発生します（月額約$9）。
    - **データ転送量（Egress）:** **これが最大の変動要因です。** TURNサーバーを経由するということは、すべてのホワイトボードデータ（本来P2Pでやり取りされるべきデータ）が、一度AWSのEC2インスタンスを経由して各クライアントにリレーされることを意味します。この`AWSからインターネットへのデータ転送量`には、比較的高額な料金がかかります。ユーザーが活発に描画すればするほど、このコストは青天井で増加します。
- **分析:** TURNサーバーが頻繁に使われる状況になると、「バックエンド運用コストを極限まで削減」というプロジェクトの前提が崩れる可能性があります。月額$7だったコストが、データ転送量だけで数十ドル〜数百ドルに達することも十分に考えられます。

---

## まとめと推奨される対策

| コストドライバー             | 影響を受けるサービス                      | コストへの影響 | シナリオ例                                     |
| -------------------------- | ----------------------------------- | ------------ | ---------------------------------------------- |
| **長時間のセッション**         | API Gateway (接続時間)                | **中**       | ユーザーが一日中ホワイトボードを開きっぱなしにする   |
| **頻繁な参加/退出**          | Lambda, DynamoDB (呼び出し/書き込み回数) | **中**       | 多くのユーザーが短時間でサービスを試す         |
| **フロントエンドへのアクセス増** | CloudFront, S3 (データ転送量)         | **中**       | アプリケーションがメディアで紹介される           |
| **TURNサーバーの利用**       | EC2 (固定費), **データ転送 (変動費)**   | **高（危険）** | 企業ユーザーが多く、P2P接続の失敗率が高い      |

**結論として、現在のアーキテクチャのコスト面での最大のリスクは、TURNサーバーの利用率です。**

この分析を踏まえ、以下の対策を検討することを推奨します。

- **モニタリング:** CloudWatchなどで、Lambdaの呼び出し回数、DynamoDBの読み書きユニット、そして特にTURNサーバーのデータ転送量を厳密に監視する仕組みを構築する。
- **アラート:** 想定外のコスト増大を早期に検知するため、特定のメトリクス（例: TURNサーバーのデータ転送量）にしきい値を設け、予算アラートを設定する。
- **情報提供:** ユーザーに対し、最適なパフォーマンスのためにはP2P接続が可能なネットワーク環境を推奨する旨を、UI上で明確に伝える。
